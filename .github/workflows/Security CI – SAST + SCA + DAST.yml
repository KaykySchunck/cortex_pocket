name: Security CI – SAST + SCA + DAST

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  security:
    name: Build, Analyze, Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # -----------------------
      # 1. SAST – SEMGREP
      # -----------------------
      - name: Install Semgrep
        run: pip install semgrep

      - name: Run Semgrep (SAST)
        run: semgrep scan --config=auto --error || true

      # -----------------------
      # 2. SCA – OWASP DEPENDENCY CHECK
      # -----------------------
      - name: Run OWASP Dependency Check
        run: |
          docker run --rm \
            -e NVD_API_KEY=${{ secrets.NVD_API_KEY }} \
            -v $(pwd):/src \
            owasp/dependency-check:latest \
            --scan /src \
            --format "ALL" \
            --out /src/dependency-check-reports

      - name: Upload SCA Reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-reports
          path: dependency-check-reports/

      # -----------------------
      # 3. BUILD CONTAINER
      # -----------------------
      - name: Build Docker Container
        run: docker compose up -d --build

      - name: Wait for container
        run: sleep 20

      - name: List Docker Networks
        run: docker network ls

      # -----------------------
      # 4. DAST – OWASP ZAP
      # -----------------------
      - name: Create ZAP directory
        run: mkdir zap-reports

      - name: Run OWASP ZAP (DAST)
        run: |
          NETWORK=$(docker network ls | grep '_default' | awk '{print $2}')
          echo "Using network: $NETWORK"

          docker run --rm \
            --network=$NETWORK \
            -v $(pwd)/zap-reports:/zap/wrk \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-full-scan.py \
            -t http://cortex-pocket-app:8081 \
            -r zap-report.html \
            -w zap-report.md \
            -J zap-report.json \
            -x zap-report.xml

      - name: Upload ZAP Reports
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports
          path: zap-reports/

      # -----------------------
      # 5. FAIL GATE
      # -----------------------
      - name: Fail on Critical/High Findings
        run: |
          HIGH=$(jq '[.site[].alerts[] | select(.riskcode == "3")] | length' zap-reports/zap-report.json)
          MEDIUM=$(jq '[.site[].alerts[] | select(.riskcode == "2")] | length' zap-reports/zap-report.json)

          echo "HIGH: $HIGH"
          echo "MEDIUM: $MEDIUM"

          if [ "$HIGH" -gt 0 ] || [ "$MEDIUM" -gt 0 ]; then
            echo "❌ Segurança reprovada."
            exit 1
          fi

      - name: Completed
        run: echo "✔ SAST + SCA + DAST executados com sucesso!"
