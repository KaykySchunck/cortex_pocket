name: Security Pipeline â€“ Build â†’ Analyze â†’ Scan

on:
  workflow_dispatch:

jobs:

  # -----------------------------------------------------
  # 1ï¸âƒ£ JOB 1 â€“ BUILD DOCKER APP
  # -----------------------------------------------------
  build:
    name: ðŸ—ï¸ Build & Validate Container
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build & start app
        run: |
          docker compose up -d --build
          echo "Aguardando aplicaÃ§Ã£o iniciar..."
          sleep 20

      - name: Test local app (HTTP)
        run: |
          echo "ðŸš€ Testando http://localhost:8081"
          curl -I http://localhost:8081 || exit 1

      - name: List containers
        run: docker ps -a

      - name: List docker networks
        run: docker network ls


  # -----------------------------------------------------
  # 2ï¸âƒ£ JOB 2 â€“ ANALYZE (SAST + SCA)
  # -----------------------------------------------------
  analyze:
    name: ðŸ” SAST + SCA (Semgrep & Dependency-Check)
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ------------- SAST â€“ SEMGREP ---------------------
      - name: Install Semgrep
        run: pip install semgrep

      - name: Run Semgrep (SAST)
        run: |
          echo "Rodando anÃ¡lise estÃ¡tica (Semgrep)..."
          semgrep scan --config=auto --error || true

      # ------------- SCA â€“ DEPENDENCY CHECK --------------
      - name: Run OWASP Dependency Check
        run: |
          mkdir dependency-check-reports
          docker run --rm \
            -v $(pwd):/src \
            owasp/dependency-check:latest \
            --scan /src \
            --format "ALL" \
            --out /src/dependency-check-reports

      - name: Upload SCA Reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-reports
          path: dependency-check-reports/


  # -----------------------------------------------------
  # 3ï¸âƒ£ JOB 3 â€“ SCAN (DAST â€“ OWASP ZAP)
  # -----------------------------------------------------
  scan:
    name: ðŸ›¡ï¸ DAST Scan (OWASP ZAP)
    runs-on: ubuntu-latest
    needs: build  # depende do job BUILD
    steps:

      - name: Checkout
        uses: actions/checkout@v4

      - name: Start app again for DAST
        run: |
          docker compose up -d --build
          sleep 20

      - name: Detect Docker network
        id: net
        run: |
          NET=$(docker network ls | grep '_default' | awk '{print $2}')
          echo "network=$NET" >> $GITHUB_OUTPUT

      - name: Show detected network
        run: echo "Rede detectada: ${{ steps.net.outputs.network }}"

      - name: Create reports folder
        run: mkdir zap-reports

      - name: Run OWASP ZAP Full Scan
        run: |
          docker run --rm \
            --network=${{ steps.net.outputs.network }} \
            -v $(pwd)/zap-reports:/zap/wrk \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-full-scan.py \
            -t http://cortex-pocket-app:8081 \
            -r zap-report.html \
            -w zap-report.md \
            -J zap-report.json \
            -x zap-report.xml

      - name: Upload ZAP Reports
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports
          path: zap-reports/

      - name: Print ZAP summary (risk codes)
        run: |
          echo "Resumo das vulnerabilidades encontradas:"
          cat zap-reports/zap-report.md || true
