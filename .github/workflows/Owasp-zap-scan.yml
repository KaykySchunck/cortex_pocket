name: Security CI

on:
  push:
    branches: [ "main", "CI-CD" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:

  # --------------------------------------------------------
  # 1. BUILD (se sua aplicação precisar ser subida para DAST)
  # --------------------------------------------------------
  build:
    name: Build Application
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build with Gradle
        run: |
          chmod +x ./gradlew
          ./gradlew build -x test

      - name: Upload JAR
        uses: actions/upload-artifact@v3
        with:
          name: app-jar
          path: |
            build/libs/*.jar

  # --------------------------------------------------------
  # 2. SAST – Semgrep
  # --------------------------------------------------------
  sast:
    name: SAST – Semgrep
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Run Semgrep SAST
        uses: returntocorp/semgrep-action@v1
        with:
          config: auto
          generate-sarif: true

      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif


  # --------------------------------------------------------
  # 3. SCA – OWASP Dependency-Check
  # --------------------------------------------------------
  sca:
    name: SCA – OWASP Dependency Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Run Dependency-Check (Docker)
        run: |
          mkdir odc-reports
          docker run --rm \
            -v $(pwd):/src \
            -v $(pwd)/odc-reports:/report \
            owasp/dependency-check:latest \
            --scan /src \
            --format "HTML,JSON,SARIF" \
            --project "Security CI" \
            --out /report \
            --failOnCVSS 7.0 || true

      - name: Upload ODC Reports
        uses: actions/upload-artifact@v3
        with:
          name: dependency-check-reports
          path: odc-reports/*

  # --------------------------------------------------------
  # 4. DAST – OWASP ZAP Full Scan (NOVO)
  # --------------------------------------------------------
  dast:
    name: DAST – OWASP ZAP Full Scan
    runs-on: ubuntu-latest
    needs: [build]   # precisa do app rodando

    steps:
      - uses: actions/checkout@v3

      # ---------------------------------
      # Baixando o JAR gerado no job build
      # ---------------------------------
      - name: Download JAR artifact
        uses: actions/download-artifact@v3
        with:
          name: app-jar
          path: app

      # ------------------------
      # Subindo aplicação local
      # ------------------------
      - name: Start application
        run: |
          nohup java -jar app/*.jar &
          sleep 15

      - name: Run OWASP ZAP Full Scan
        run: |
          mkdir zap-reports

          docker run --network="host" \
            -v $(pwd)/zap-reports:/zap/wrk/:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-full-scan.py \
            -t http://localhost:8080 \
            -g gen.conf \
            -r zap-report.html \
            -w zap-report.md \
            -J zap-report.json \
            -x zap-report.xml

      - name: Upload ZAP Reports
        uses: actions/upload-artifact@v3
        with:
          name: zap-reports
          path: zap-reports/*

      # ----------------------------------------------------
      # FALHAR PIPELINE EM ALERTAS HIGH ou CRITICAL
      # ----------------------------------------------------
      - name: Fail build on HIGH/CRITICAL issues
        run: |
          HIGH=$(jq '[.site[].alerts[] | select(.riskcode == "3")] | length' zap-reports/zap-report.json)
          CRITICAL=$(jq '[.site[].alerts[] | select(.riskcode == "4")] | length' zap-reports/zap-report.json)

          echo "High Findings: $HIGH"
          echo "Critical Findings: $CRITICAL"

          if [ "$HIGH" -gt 0 ] || [ "$CRITICAL" -gt 0 ]; then
            echo "❌ Vulnerabilities detected!"
            exit 1
          fi

  # --------------------------------------------------------
  # 5. GATE FINAL (só libera deploy se todos passarem)
  # --------------------------------------------------------
  ready_to_deploy:
    name: Ready to deploy
    runs-on: ubuntu-latest
    needs: [sast, sca, dast]

    steps:
      - name: Status
        run: echo "✔ All security checks passed!"

