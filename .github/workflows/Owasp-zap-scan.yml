name: Security CI – OWASP ZAP

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:

  # ----------------------------------------------------
  # 1. Subir a aplicação containerizada com Docker Compose
  # ----------------------------------------------------
  start_app:
    name: Start Application Container
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Start application with Docker Compose
        run: |
          docker compose up -d --build
          echo "Aguardando app container subir..."
          sleep 15

      - name: Validate app is running
        run: |
          curl -I http://localhost:8081 || exit 1

  # ----------------------------------------------------
  # 2. DAST – OWASP ZAP FULL SCAN EM DOCKER
  # ----------------------------------------------------
  zap_scan:
    name: OWASP ZAP DAST Scan
    needs: start_app
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Create reports directory
        run: mkdir zap-reports

      - name: Run OWASP ZAP Full Scan
        run: |
          docker run --rm \
            --network="host" \
            -v $(pwd)/zap-reports:/zap/wrk \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-full-scan.py \
            -t http://localhost:8081 \
            -r zap-report.html \
            -w zap-report.md \
            -J zap-report.json \
            -x zap-report.xml \
            -g zap-conf.conf \
            -d

      - name: Upload ZAP Reports
        uses: actions/upload-artifact@v3
        with:
          name: zap-reports
          path: zap-reports/

      # -------------------------------------------
      # Falhar pipeline em vulnerabilidades críticas ou médias
      # -------------------------------------------
      - name: Fail on HIGH or MEDIUM findings
        run: |
          HIGH=$(jq '[.site[].alerts[] | select(.riskcode == "3")] | length' zap-reports/zap-report.json)
          MEDIUM=$(jq '[.site[].alerts[] | select(.riskcode == "2")] | length' zap-reports/zap-report.json)

          echo "Vulnerabilidades HIGH: $HIGH"
          echo "Vulnerabilidades MEDIUM: $MEDIUM"

          if [ "$HIGH" -gt 0 ] || [ "$MEDIUM" -gt 0 ]; then
            echo "❌ Vulnerabilidades encontradas!"
            exit 1
          fi

  # ----------------------------------------------------
  # 3. Gate Final – aprovado
  # ----------------------------------------------------
  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [zap_scan]
    if: success()

    steps:
      - name: Security Approved
        run: echo "✔ Nenhuma vulnerabilidade crítica ou média encontrada."

