name: OWASP-ZAP-Scan

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  zap-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do repositorio
        uses: actions/checkout@v4

      - name: Verificar estrutura e definir caminho
        run: |
          echo "Verificando estrutura..."
          ls -la
          if [ -d "web-server" ]; then
            echo "WEB_SERVER_PATH=web-server" >> $GITHUB_ENV
            echo "OK - web-server encontrado na raiz"
          elif [ -d "cortex-pocket/web-server" ]; then
            echo "WEB_SERVER_PATH=cortex-pocket/web-server" >> $GITHUB_ENV
            echo "OK - web-server encontrado em cortex-pocket/"
          else
            echo "ERRO - web-server nao encontrado!"
            exit 1
          fi

      - name: Subir servidor com Docker Compose
        run: |
          cd ${{ env.WEB_SERVER_PATH }}
          echo "Subindo container..."
          docker compose up -d --build
          sleep 5
          docker ps

      - name: Verificar servidor esta respondendo
        run: |
          echo "Verificando health check em http://localhost:8081/health..."
          for i in {1..20}; do
            if curl -f -s http://localhost:8081/health > /dev/null 2>&1; then
              echo "OK - Servidor rodando e respondendo!"
              curl -s http://localhost:8081/health
              break
            fi
            if [ $i -eq 20 ]; then
              echo "ERRO - Servidor nao iniciou apos 20 tentativas"
              docker logs cortex-pocket-web || true
              exit 1
            fi
            echo "Tentativa $i/20..."
            sleep 1
          done

      - name: Criar diretorio para relatorios
        run: mkdir -p zap-output

      - name: Executar OWASP ZAP Baseline Scan
        run: |
          echo "Executando ZAP Scan..."
          docker run --rm \
            --network="container:cortex-pocket-web" \
            -v $(pwd)/zap-output:/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
            -t http://localhost:8081 \
            -r /zap/wrk/zap_report.html \
            -x /zap/wrk/zap_report.xml \
            -J /zap/wrk/zap_report.json \
            -I

      - name: Upload dos relatorios
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-reports
          path: zap-output/

      - name: Derrubar containers
        if: always()
        run: |
          cd ${{ env.WEB_SERVER_PATH }}
          docker compose down || true
